{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}

{% if form.non_field_errors %}
<div class="alert alert-danger">
    <ul>
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if item_formset.non_field_errors %}
<div class="alert alert-danger">
    <ul>
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<section class="section">
    <div class="section-header bg-white">
        <div class="d-flex justify-content-between align-items-center py-3 px-3 px-md-5">
            <div>
                <h1>Create Declaration</h1>
            </div>
            
            <div class="d-flex align-items-center">
                <div class="">
                    <a href="{% url 'view_declaration' %}" class="nav-link text-center header_success_button" >
                        <span class=" d-xl-inline">Back</span>
                    </a>
                </div>
            </div>
                
        </div>
    </div>
</section>
<section class="section form-container mb-5 p-2 p-sm-3 p-md-5">
    <form class="needs-validation" novalidate id="declaration-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="default-form mb-4">
            <!-- <div class="d-flex justify-content-end">
                <a class="btn navbar-card-button text-white px-4 mb-4" href="{% url 'view_declaration' %}">Back</a>
            </div> -->
            <div class="mb-4 form_heading">
                <h2 class="font-20 py-2 px-3">Declaration Information</h2>
            </div>
            <div class="d-flex flex-wrap">
                <div class="col-12">
                    <div class="row gx-3 pe-sm-3">
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_declaration_date">Declaration Date:</label>
                                {{ form.declaration_date }}
                                {{ form.declaration_date.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Request No:</label>
                                {{ form.request_no }}
                                {{ form.request_no.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_declaration_no">Declaration No:</label>
                                {{ form.declaration_no }}
                                {{ form.declaration_no.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_net_weight">Net Weight:</label>
                                {{ form.net_weight }}
                                {{ form.net_weight.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_gross_weight">Gross Weight:</label>
                                {{ form.gross_weight }}
                                {{ form.gross_weight.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_measurements">Measurements:</label>
                                {{ form.measurements }}
                                {{ form.measurements.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_nmbr_of_packages">Number of Packages:</label>
                                {{ form.nmbr_of_packages }}
                                {{ form.nmbr_of_packages.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_cargo_type">Cargo Type:</label>
                                {{ form.cargo_type }}
                                {{ form.cargo_type.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_declaration_type">Declaration Type:</label>
                                {{ form.declaration_type }}
                                {{ form.declaration_type.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_cargo_channel">Cargo Channel:</label>
                                {{ form.cargo_channel }}
                                {{ form.cargo_channel.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_transaction_type">Transaction Type:</label>
                                {{ form.transaction_type }}
                                {{ form.transaction_type.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_trade_type">Trade Type:</label>
                                {{ form.trade_type }}
                                {{ form.trade_type.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_regime_type">Regime Type:</label>
                                {{ form.regime_type }}
                                {{ form.regime_type.errors }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="default-form mb-4">
            <div class="mb-4 form_heading">
                <h2 class="font-20 py-2 px-3">Items</h2>
            </div>
            <div class="d-flex flex-wrap">
                <div class="col-12 item">
                    {{ item_formset.management_form }}
                    <div class="row gx-3 pe-sm-3 item-form">
                        {% for form in item_formset %}
                        <div class="col-12">
                            <label class="font-14" for="id_declaration_date">Description</label>
                                <div class="row mb-3">
                                    <div class="col-11">
                                        {{ form.goods_description |add_class:"form-control"|attr:"rows:1" }}
                                        {{ form.goods_description.errors }}
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="input-group-text update_button text-white justify-content-center search-bttn">Search</button>
                                    </div>
                                </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">HsCode</label>
                            <div class="row">
                                <div class="col-11">
                                    {{ form.hs_code |add_class:"form-control"}}
                                    {{ form.hs_code.errors }}
                                </div>
                                <div class="col-1">
                                    <button type="button" class="input-group-text update_button text-white justify-content-center reset-btn">Reset</button>
                                </div>
                            </div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <template id="document-template">
                                <div class="document-form">
                                    <!-- Default document input fields go here -->
                                    <label class="font-14 label" for="id_request_noe">Documents</label>
                                    <input class="form-control" type="file" name="documents" placeholder="">
                                </div>
                            </template>
                            <div class="form-group mb-3 document-form" data-item-index="{{ forloop.counter0 }}" >
                                <label class="font-14 label" for="id_request_noe">Documents</label>
                                <input class="form-control" type="file" name="documents" placeholder="">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Static Quantity Unit</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.static_quantity_unit |add_class:"form-control" }}
                                {{ form.static_quantity_unit.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Supplementary Quantity Unit</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.supp_quantity_unit |add_class:"form-control"}}
                                {{ form.supp_quantity_unit.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Unit Weight</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.unit_weight |add_class:"form-control"}}
                                {{ form.unit_weight.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Goods Value</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.goods_value|add_class:"form-control" }}
                                {{ form.goods_value.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">CIF Value</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.cif_value|add_class:"form-control" }}
                                {{ form.cif_value.errors }}
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="form-group mb-3">
                                <label class="font-14" for="id_request_noe">Duty Fee</label>
                                <!-- <input class="form-control" type="text" name="" placeholder=""> -->
                                {{ form.duty_fee|add_class:"form-control" }}
                                {{ form.duty_fee.errors }}
                            </div>
                        </div>
                        <div class="form-group mb-0 mt-4 d-flex justify-content-between">
                            <button type="button" id="add-row" class="add-card-button w-20 me-2">Add Item</button>
                            <input type="checkbox" name="{{ form.prefix }}-DELETE" class="delete-row" style="display: none;">
                            <button type="button" id="delete-btn" class="btn delete-button btn-danger warning_button w-20 me-2">Delete Item</button>
                        </div>
                        
                        {% endfor %}
                    </div> 
                </div>
            </div>
        </div>
        <div class="row p-2">
        <div class="form-group d-flex justify-content-between">
            <button type="submit"  class="submit-button">Submit</button>
            <button type="submit" name="save_draft" value="True" class="submit-button">Save as Draft</button>
        </div>
    </div>
    </form>
</section>

<script type="text/javascript">
      
    document.addEventListener('DOMContentLoaded', function () {
        var originalDescriptions = {};
        let requiredDocsData = {};

        function attachValidationListeners(row) {
            var numericFields = row.querySelectorAll('input[type="number"]');
            numericFields.forEach(function (field) {
                var errorSpan = document.createElement('span');
                errorSpan.style.display = 'none';
                errorSpan.style.color = 'red';
                errorSpan.textContent = 'Invalid number';
                field.parentNode.insertBefore(errorSpan, field.nextSibling);
                field.addEventListener('input', function () {
                    if (!field.checkValidity()) {
                        field.nextElementSibling.style.display = 'inline';
                    } else {
                        field.nextElementSibling.style.display = 'none';
                    }
                });
            });
        }

    document.getElementById('add-row').addEventListener('click', function () {
        
    var mainForm = document.querySelector('.item')
    var formContainer = document.querySelector('.item-form'); 
    var newForm = formContainer.cloneNode(true);
    var totalForms = document.getElementById('id_items_set-TOTAL_FORMS'); 
    var currentFormCount = parseInt(totalForms.value); 
   
    var regex = new RegExp(`items_set-\\d+-`, 'g');
    newForm.innerHTML = newForm.innerHTML.replace(regex, `items_set-${currentFormCount}-`);

    var documentTemplate = document.getElementById('document-template').innerHTML;
    var documentsCell = newForm.querySelector('.document-form');
            if (documentsCell) {
                documentsCell.innerHTML = documentTemplate;
                documentsCell.dataset.itemIndex = currentFormCount;
               
            }
   
    var inputs = newForm.querySelectorAll('input, textarea');
    inputs.forEach(function (input) {
                if (input.type === 'hidden') {
                    input.value = '';
                } else {
                    input.value = '';
                    input.removeAttribute('readonly');
                } 
    });

    mainForm.appendChild(newForm);
    totalForms.value = currentFormCount + 1;
    attachValidationListeners(newForm);
});


function updateFormIndices() {
    var forms = document.querySelectorAll('.item-form');
    forms.forEach(function (form, index) {
        form.setAttribute('data-item-index', index);
        
     
        var inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function (input) {
            if (input.name) {
                input.name = input.name.replace(/items_set-\d+-/, `items_set-${index}-`);
            }
            if (input.id) {
                input.id = input.id.replace(/items_set-\d+-/, `items_set-${index}-`);
            }
        });

   
        var documentForm = form.querySelector('.document-form');
        if (documentForm) {
            
            documentForm.setAttribute('data-item-index', index);

        
            var fileInputs = documentForm.querySelectorAll('input[type="file"]');
            fileInputs.forEach(function (fileInput) {
                var docIdMatch = fileInput.name.match(/documents_\d+_([a-f0-9\-]{36})/); // Capture the full UUID
                if (docIdMatch) {
                    var docId = docIdMatch[1];
                    fileInput.name = `documents_${index}_${docId}`; 
                }
            });
        }
    
    });

    
    var totalForms = document.getElementById('id_items_set-TOTAL_FORMS');
    totalForms.value = forms.length;
}


document.querySelector('.item').addEventListener('click', function (e) {
  
            if (e.target.classList.contains('delete-button')) {
          


                e.preventDefault();
                var row = e.target.closest('.item-form');

                var descriptionField = row.querySelector('textarea[name*="description"]');


if (descriptionField && originalDescriptions.hasOwnProperty(descriptionField.name)) {
    delete originalDescriptions[descriptionField.name];
}
console.log("originalDescriptions",originalDescriptions)
              
                var deleteCheckbox = row.querySelector('input[type="checkbox"]');
                console.log("deleteCheckbox",deleteCheckbox)
                deleteCheckbox.checked = true;
                deleteCheckbox.value = 'true';
               row.remove();
                updateFormIndices();

            }
        });

    document.querySelector('.item').addEventListener('click', function (e) {
        if (e.target.classList.contains('reset-btn')) {
            var formGroup = e.target.closest('.item-form');
            
            // Find the description field and clear it
            var descriptionField = formGroup.querySelector('textarea[name*="goods_description"]');
            

            if (descriptionField) {
                
                descriptionField.value = '';  // Clear the description field
                descriptionField.readOnly = false;  // Re-enable the description field
            }

            // Clear the HS code dropdown
            var hsCodeDropdown = formGroup.querySelector('select[name*="hs_code"]');
            if (hsCodeDropdown) {
                hsCodeDropdown.value = '';  // Reset the HS code dropdown
            }

            // Clear the document fields
            var documentForm = formGroup.querySelector('.document-form');
            var documentsField = formGroup.querySelector('input[type="file"]');
            var fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = 'documents';
            fileInput.required = true;
            fileInput.classList.add('form-control'); 
            fileInput.placeholder = '';   
            var label = document.createElement('label');
            label.classList.add('font-14'); 
             label.textContent = "Document";
            
            if (documentForm) {
                documentForm.innerHTML = '';
                documentForm.appendChild(label);
                documentForm.appendChild(fileInput  );

                
                
            }

            // Optionally, remove from originalDescriptions if needed
            if (descriptionField && originalDescriptions[descriptionField.name]) {
                delete originalDescriptions[descriptionField.name];
            }

            console.log("Form reset");
        }
    });


document.querySelector('.item').addEventListener('click', function (e) {
    if (e.target.classList.contains('search-bttn')) {
       
       
        var formGroup = e.target.closest('.form-group');

        var descriptionField = formGroup.querySelector('textarea');
        var descriptionData = descriptionField.value;
        var hsCodeDropdown = formGroup.parentElement.nextElementSibling.querySelector('select[name*="hs_code"]');

        fetch('/search-hscode/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ description: descriptionData })
        })
        .then(response => response.json())
        .then(data => {
            hsCodeDropdown.innerHTML = '';

            var placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Select your HS code';
            hsCodeDropdown.appendChild(placeholderOption);

            data.hs_codes.forEach(function (hsCode) {
                var option = document.createElement('option');
                option.value = hsCode.id;
                option.textContent = `${hsCode.hs_code} - ${hsCode.description}`;
                hsCodeDropdown.appendChild(option);
            });

            descriptionField.dataset.originalValue = descriptionField.value;

            hsCodeDropdown.addEventListener('change', function () {
                originalDescriptions[descriptionField.name] = descriptionField.value;
                descriptionField.readOnly = true; 
            });
           
        })
        .catch(error => console.error('Error:', error));
    }
});
    attachValidationListeners(document);
        
// Add event listener for hs_code change
document.querySelector('.item').addEventListener('change', function (e) {
    if (e.target.name.includes('hs_code')) {
     
      
        var formGroup = e.target.closest('.form-group');
       
        var hsCode = e.target.value;
       
        var documentsField = formGroup.parentElement.nextElementSibling.querySelector('input[type="file"]');
        var documentform = formGroup.parentElement.nextElementSibling.querySelector('.document-form')
       
        var itemIndex = documentform.dataset.itemIndex;

        fetch(`/get-required-docs/?hs_code=${hsCode}`)
            .then(response => response.json())
            .then(data => {
            
                documentform.innerHTML = '';
                requiredDocsData[hsCode] = data.required_docs;

    data.required_docs.forEach(function (doc) {
    var label = document.createElement('label');
    label.classList.add('font-14'); 
    label.textContent = `${doc.name} (${doc.format})`;

    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.name = `documents_${itemIndex}_${doc.id}`;
    fileInput.required = true;
    fileInput.classList.add('form-control','required-file'); 
    fileInput.placeholder = ''; 

    documentform.appendChild(label);
    documentform.appendChild(fileInput);
});

})
.catch(error => console.error('Error:', error));
    }
});



  // Form submission validation
document.querySelector('form').addEventListener('submit', function (e) {
    var isValid = true;
    console.log("i am in ",originalDescriptions)
    
    // Check for required file inputs
    var requiredFiles = document.querySelectorAll('.required-file');
    requiredFiles.forEach(function (input) {
        if (!input.files.length) {
            e.preventDefault();
            alert('You must upload all required files.');
        }
    });

    // Select all item forms in the grid
    var items = document.querySelectorAll('.item-form');

    items.forEach(function (item) {
        console.log("inside items")
        var hsCodeDropdown = item.querySelector('select[name*="hs_code"]');
        var hsCode = hsCodeDropdown ? hsCodeDropdown.value : null;

        var documentField = item.querySelector('.document-form');
        var itemIndex = documentField.getAttribute('data-item-index');
        
        var requiredDocs = requiredDocsData[hsCode] || [];
        
        // Validate file uploads for each required document
        requiredDocs.forEach(function (doc) {
            var fileInput = item.querySelector(`input[name="documents_${itemIndex}_${doc.id}"]`);
            if (fileInput && fileInput.files.length > 0) {
                var file = fileInput.files[0];
                var ext = file.name.split('.').pop().toLowerCase();
                if (!doc.format.split(',').includes(ext)) {
                    e.preventDefault();
                    alert(`Invalid file format for ${doc.name}: ${ext}`);
                    fileInput.value = ''; // Clear the invalid file input
                }
            }
        });
    });


        
    
});
    });

</script>

{% endblock content %}
{% extends "base.html" %}
{% load static %}
{% block content %}


<style>
  .font-7 {
    font-size: 0.7rem !important;
  }
  .sub-heading {
    min-height: auto;
    padding: 0 0 12px 0 !important;
  }
  .file-input {
    display: block;
    width: 100%;
    height: 100%;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    box-shadow: none;
    outline: none;
    font-size: 0.8125rem;
    line-height: 2.8;
    background-color: var(--tw-light-active);
    border-radius: 0.375rem;
    height: 2.5rem;
    padding: 0 1rem 0 0;
    border: 1px solid var(--tw-gray-300);
    color: var(--tw-gray-700);
  }
  input::file-selector-button {
    color: var(--tw-gray-700);
    background-color: transparent;
    border: none;
    border-right: 1px solid var(--tw-gray-300);
  }
  select[readonly] {
    pointer-events: none; /* Disable click */
    touch-action: none; /* Disable touch */
    background-color: white; /* Greyed-out look similar to disabled */
}
</style>
<!-- Content -->
<main class="grow content pt-7" id="content" role="content">
  <!-- Toolbar -->
  <div class="pb-7">
    <!-- Container -->
    <div
      class="container-fixed flex items-center justify-between flex-wrap gap-3"
    >
      <div class="flex flex-col flex-wrap gap-1">
        <h1 class="font-medium text-lg text-gray-900">Update Declaration</h1>
        <div class="flex items-center gap-1 text-sm font-normal">
          <a class="text-gray-700 hover:text-primary" href="#"> Home </a>
          <span class="text-gray-400 text-sm"> / </span>
          <span class="text-gray-900"> Update Declaration </span>
        </div>
      </div>
    </div>
    <!-- End of Container -->
  </div>
  <!-- End of Toolbar -->
  <style>
    .hero-bg {
      background-image: url("assets/media/images/2600x1200/bg-1.png");
    }
    .dark .hero-bg {
      background-image: url("assets/media/images/2600x1200/bg-1-dark.png");
    }
  </style>

  <form
    class="needs-validation"
    novalidate
    id="declaration-form"
    method="post"
    enctype="multipart/form-data"
  >
    <!-- Container -->
    {% csrf_token %}
    <div class="container-fixed">
      <div class="grid gap-5 lg:gap-7.5">
        <div class="card card-grid min-w-full p-10">
          <div class="grid grid-cols-2 gap-4">
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_declaration_date">
                Declaration Date: <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="declaration_date" name="declaration_date"
                  placeholder=""
                  type="date"
                  value="{{ declaration_data.declaration_date|date:'Y-m-d' }}"
                  required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_request_noe">
                Request No<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="request_no" name="request_no"
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.request_no }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_declaration_no">
                Declaration No<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="declaration_no" name="declaration_no"
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.declaration_no }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_net_weight">
                Net Weight<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="net_weight" name="net_weight"
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.net_weight }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_gross_weight">
                Gross Weight<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="gross_weight" name="gross_weight" 
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.gross_weight }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_measurements">
                Measurements<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="measurements" name="measurements"
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.measurements }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_nmbr_of_packages">
                Number of Packages<span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <input
                  class="input"
                  id="nmbr_of_packages" name="nmbr_of_packages"
                  placeholder=""
                  type="number"
                  value="{{ declaration_data.nmbr_of_packages }}" required
                />
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_cargo_type">
                Cargo Type <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" id="cargo_type" name="cargo_type">
                  {% for cargo_type in cargo_types %}
                    <option value="{{ cargo_type.id }}" {% if cargo_type.id == declaration_data.cargo_type.id %}selected{% endif %}>
                        {{ cargo_type.name }}
                    </option>
                 {% endfor %}
                </select>
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_declaration_type">
                Declaration Type <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" id="declaration_type" name="declaration_type">
                    {% for declaration_type in declaration_types %}
                    <option value="{{ declaration_type.id }}" {% if declaration_type.id == declaration_data.declaration_type.id %}selected{% endif %}>
                        {{ declaration_type.name }}
                    </option>
                {% endfor %}
                </select>
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_cargo_channel">
                Cargo Channel <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" name="select" id="cargo_channel" name="cargo_channel">
                    {% for cargo_channel in cargo_channels %}
                    <option value="{{ cargo_channel.id }}" {% if cargo_channel.id == declaration_data.cargo_channel.id %}selected{% endif %}>
                        {{ cargo_channel.name }}
                    </option>
                {% endfor %}
                </select>
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_transaction_type">
                Transaction Type <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" id="transaction_type" name="transaction_type">
                    {% for transaction_type in transaction_types %}
                    <option value="{{ transaction_type.id }}" {% if transaction_type.id == declaration_data.transaction_type.id %}selected{% endif %}>
                        {{ transaction_type.name }}
                    </option>
                {% endfor %}
                </select>
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_trade_type">
                Trade type <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" id="trade_type" name="trade_type">
                    {% for trade_type in trade_types %}
                    <option value="{{ trade_type.id }}" {% if trade_type.id == declaration_data.trade_type.id %}selected{% endif %}>
                        {{ trade_type.name }}
                    </option>
                {% endfor %}
                </select>
              </div>
            </div>
            <div
              class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5"
            >
              <label class="form-label" for="id_regime_type">
                Regime type <span class="text-danger pl-2">*</span>
              </label>
              <div class="flex flex-col w-full gap-1">
                <select class="select" name="select" id="regime_type" name="regime_type">
                    {% for regime_type in regime_types %}
                    <option value="{{ regime_type.id }}" {% if regime_type.id == declaration_data.regime_type.id %}selected{% endif %}>
                        {{ regime_type.name }}
                    </option>
                {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card card-grid min-w-full p-10">
            <div class="card-header sub-heading">
                <h3 class="card-title">
                    Items details
                </h3>
            </div>
            <div class="item">
            {{ item_formset.management_form }}
            {% for item in items_data %}
            <div class="item-form" data-item-id="{{ item.id }}">
                <input type="hidden" name="items_set-id" value="{{ item.id }}">
            <div class="grid grid-cols-1 gap-4 pt-5">
                <div class="flex flex-col flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_declaration_date">
                        Description <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="input-group">
                        <input class="input" placeholder="" type="text" name="items_set-{{ forloop.counter0 }}-description" value="{{ item.description }}">
                        <span class="btn btn-primary update_button search-bttn">
                            Search
                        </span>
                    </div>
                </div>
                <div class="flex flex-col flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        HsCode <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="input-group">
                            <select class="select input" name="items_set-{{ forloop.counter0 }}-hs_code">
                                {% for hs_code in hs_codes %}
                                <option value="{{ hs_code.id }}" {% if hs_code.id == item.hs_code.id %}selected{% endif %}>{{ hs_code.hs_code }}</option>
                            {% endfor %}
                            </select>
                        <span class="btn btn-primary update_button reset-btn">
                            Reset
                        </span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 pt-5">
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5 document-form form-group" data-item-index="{{ forloop.counter0 }}">
                    <label class="form-label" for="id_request_noe">
                        Documents <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                        {% for document_formset in document_formsets %}
                                                    {% if document_formset.item.id == item.id %}
                                                        {% for doc in document_formset.documents %}
                                                            <input type="file" class="file-input custom-file-input form-control" name="documents_item_{{ document_formset.item.id }}_{{ doc.required_doc.id }}"value="{{ doc.file }}">
                                                            {% if doc.file %}
                                                                <a href="{{ doc.file.url }}" target="_blank">{{ doc.file }}</a>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        Static Quantity Unit <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-static_quantity_unit" value="{{ item.static_quantity_unit }}" required/>
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        Supplementary Quantity Unit <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-supp_quantity_unit" value="{{ item.supp_quantity_unit }}" required/>
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        Unit Weight <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-unit_weight" value="{{ item.unit_weight }}" required/>
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        Goods Value <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-goods_value" value="{{ item.goods_value }}" required/>
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        CIF Value <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-cif_value" value="{{ item.cif_value }}" required/>
                    </div>
                </div>
                <div class="flex flex-col items-baseline flex-wrap lg:flex-nowrap gap-2.5">
                    <label class="form-label" for="id_request_noe">
                        Duty Fee <span class="text-danger pl-2">*</span>
                    </label>
                    <div class="flex flex-col w-full gap-1">
                      <input class="input" placeholder="" type="number" name="items_set-{{ forloop.counter0 }}-duty_fee" value="{{ item.duty_fee }}" required/>
                    </div>
                </div>
            </div>
            <div class="mt-5 pt-1 flex gap-4 justify-end">
            <input type="checkbox" name="{{ form.prefix }}-DELETE" class="delete-row" style="display: none;">
              <button class="btn btn-danger min-w-20 flex justify-center delete-button" id="delete-btn"> Delete 
              </button>
          </div>
            {% endfor %}
        </div>
      </div>
         </div>
         <div class="mb-10 flex justify-end gap-4">
            <button class="btn btn-primary min-w-20 flex justify-center" type="submit"  class="submit-button">
              Submit 
            </button>
         </div>
      </div>
    </div>
  </form>
  <!-- End of Container -->
</main>
<!-- End of Content -->
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var originalDescriptions = {};
        let requiredDocsData = {};

        document.querySelector('.item').addEventListener('click', function (e) {

            if (e.target.classList.contains('search-bttn')) {
                var row = e.target.closest('.item-form');
                var itemId = row.dataset.itemId;
                var descriptionField = row.querySelector('input[name^="items_set-"][name$="-description"]');
                var descriptionData = descriptionField.value;
                var hsCodeDropdown = row.querySelector('select[name*="hs_code"]');

                fetch(`/update-search-hscode/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ description: descriptionData })
                })
                    .then(response => response.json())
                    .then(data => {
                        hsCodeDropdown.innerHTML = '';

                        // Add the "Select your HS code" option
                        var placeholderOption = document.createElement('option');
                        placeholderOption.value = '';
                        placeholderOption.textContent = 'Select your HS code';
                        hsCodeDropdown.appendChild(placeholderOption);

                        data.hs_codes.forEach(function (hsCode) {
                            var option = document.createElement('option');
                            option.value = hsCode.id;
                            option.textContent = `${hsCode.hs_code} - ${hsCode.description}`;
                            hsCodeDropdown.appendChild(option);
                        });
                        descriptionField.dataset.originalValue = descriptionField.value;

                        // hsCodeDropdown.addEventListener('click', function () {
                        //     originalDescriptions[descriptionField.name] = descriptionField.value;
                        // });

                        hsCodeDropdown.addEventListener('change', function () {
                            originalDescriptions[descriptionField.name] = descriptionField.value;
                            descriptionField.readOnly = true; 
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }
        });


        document.querySelector('.item').addEventListener('click', function (e) {
        if (e.target.classList.contains('reset-btn')) {
            var formGroup = e.target.closest('.item-form');
            
            
            var descriptionField = formGroup.querySelector('input[name^="items_set-"][name$="-description"]');
            
            if (descriptionField) {
               
                descriptionField.value = '';  
                descriptionField.readOnly = false;  
            }

            
            var hsCodeDropdown = formGroup.querySelector('select[name*="hs_code"]');
            if (hsCodeDropdown) {
                hsCodeDropdown.value = ''; 
            }

            var documentForm = formGroup.querySelector('.document-form');
            var documentsField = formGroup.querySelector('input[type="file"]');  
            var label = document.createElement('label');
            label.classList.add('font-14'); 
             label.textContent = "Document";
          
            if (documentForm) {
                documentForm.innerHTML = '';
                documentForm.appendChild(label);
                documentForm.appendChild(documentsField);
            }

          
            if (descriptionField && originalDescriptions[descriptionField.name]) {
                delete originalDescriptions[descriptionField.name];
            }
        }
    });


        document.querySelector('.item').addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-button')) {
                e.preventDefault();
                var row = e.target.closest('.item-form');
                var itemId = row.dataset.itemId;

                // AJAX call to mark the item as deleted
                fetch(`/delete-item/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ is_deleted: true })
                })
                    .then(response => {
                        if (response.ok) {

                            var deleteCheckbox = row.querySelector('input[type="checkbox"].delete-row');
                            row.style.display = 'none';
                        } else {
                            alert('Error: Unable to delete the item.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: Unable to delete the item.');
                    });
            }
        });

        // Custom validation for numeric fields
        var numericFields = document.querySelectorAll('input[type="number"]');
        numericFields.forEach(function (field) {
            var errorSpan = document.createElement('span');
            errorSpan.style.display = 'none';
            errorSpan.style.color = 'red';
            errorSpan.textContent = 'Invalid number';
            field.parentNode.insertBefore(errorSpan, field.nextSibling);

            field.addEventListener('input', function () {
                if (!field.checkValidity()) {
                    errorSpan.style.display = 'inline';
                } else {
                    errorSpan.style.display = 'none';
                }
            });
        });
        // Add event listener for hs_code change
        document.querySelector('.item').addEventListener('change', function (e) {
            if (e.target.name.includes('hs_code')) {
                var row = e.target.closest('.item-form');
                var hsCode = e.target.value;
                var documentField =  row.querySelector('.document-form');
                var item = row.dataset.itemId;

                fetch(`/get-required-docs/?hs_code=${hsCode}`)
                    .then(response => response.json())
                    .then(data => {
                        documentField.innerHTML = '';

                        requiredDocsData[hsCode] = data.required_docs;
                        data.required_docs.forEach(function (doc) {
                            var fileInput = document.createElement('input');
                            fileInput.type = 'file';
                            fileInput.name = `new_documents_${item}_${doc.id}`;
                            fileInput.required = true;
                            fileInput.classList.add('form-control','required-file',"custom-file-input","file-input");
                            var label = document.createElement('label');
                            label.classList.add('font-14'); 
                            label.textContent = `${doc.name} (${doc.format})`;

                            documentField.appendChild(label);
                            documentField.appendChild(fileInput);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }
        });

        // Form submission validation

  // Form submission validation
  document.querySelector('form').addEventListener('submit', function (e) {
    var isValid = true;
    
    // Check for required file inputs
    var requiredFiles = document.querySelectorAll('.required-file');
    requiredFiles.forEach(function (input) {
        if (!input.files.length) {
            e.preventDefault();
            alert('You must upload all required files.');
        }
    });

    // Select all item forms in the grid
    var items = document.querySelectorAll('.item-form');

    items.forEach(function (item) {
        var hsCodeDropdown = item.querySelector('select[name*="hs_code"]');
        var hsCode = hsCodeDropdown ? hsCodeDropdown.value : null;

        var documentField = item.querySelector('.document-form');
        var itemIndex = documentField.getAttribute('data-item-index');
        
        var requiredDocs = requiredDocsData[hsCode] || [];
        
        // Validate file uploads for each required document
        requiredDocs.forEach(function (doc) {
            var fileInput = item.querySelector(`input[name="documents_${itemIndex}_${doc.id}"]`);
            if (fileInput && fileInput.files.length > 0) {
                var file = fileInput.files[0];
                var ext = file.name.split('.').pop().toLowerCase();
                if (!doc.format.split(',').includes(ext)) {
                    e.preventDefault();
                    alert(`Invalid file format for ${doc.name}: ${ext}`);
                    fileInput.value = ''; // Clear the invalid file input
                }
            }
        });
    });


        
    
});

    });

</script>

{% endblock content %}
